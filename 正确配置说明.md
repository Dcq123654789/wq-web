# Token æ‹¦æˆªå™¨ - æœ€ç»ˆæ­£ç¡®é…ç½®

## âœ… æ­£ç¡®æ–¹æ¡ˆ

**å…³é”®ç†è§£**ï¼š`.umirc.ts` ä¸­çš„æ‹¦æˆªå™¨**å‡½æ•°**ä¼šåœ¨**è¿è¡Œæ—¶**æ‰§è¡Œï¼Œå¯ä»¥è®¿é—®æµè§ˆå™¨çš„ `localStorage`

### ğŸ“ é…ç½®ä½ç½®

**`.umirc.ts`** - ç¼–è¯‘æ—¶é…ç½®æ–‡ä»¶
```typescript
export default defineConfig({
  request: {
    timeout: 60000,
    requestInterceptors: [
      (config: any) => {
        // âš ï¸ è¿™ä¸ªå‡½æ•°åœ¨è¿è¡Œæ—¶æ‰§è¡Œï¼Œå¯ä»¥è®¿é—® localStorage
        const accessToken = typeof localStorage !== 'undefined'
          ? localStorage.getItem('accessToken')
          : null;

        if (accessToken) {
          config.headers = {
            ...config.headers,
            Authorization: `Bearer ${accessToken}`,
          };
        }

        return config;
      },
    ],
  },
});
```

### ğŸ”‘ å…³é”®ç‚¹

1. **å‡½æ•°åœ¨è¿è¡Œæ—¶æ‰§è¡Œ**ï¼šè™½ç„¶é…ç½®åœ¨ `.umirc.ts` ä¸­ï¼Œä½†æ‹¦æˆªå™¨å‡½æ•°åœ¨è¿è¡Œæ—¶è¢«è°ƒç”¨
2. **localStorage æ£€æŸ¥**ï¼šä½¿ç”¨ `typeof localStorage !== 'undefined'` ç¡®ä¿åœ¨æµè§ˆå™¨ç¯å¢ƒ
3. **ä¸éœ€è¦é¢å¤–æ–‡ä»¶**ï¼šæ‰€æœ‰é…ç½®åœ¨ `.umirc.ts` ä¸­å®Œæˆ
4. **ä¸éœ€è¦ app.tsx é…ç½®**ï¼š`app.tsx` åªç”¨äºè¿è¡Œæ—¶é…ç½®ï¼ˆgetInitialStateã€onRouteChange ç­‰ï¼‰

## ğŸš€ æµ‹è¯•æ­¥éª¤

### 1. å®Œå…¨é‡å¯ï¼ˆå¿…é¡»ï¼ï¼‰

```bash
# åœæ­¢æœåŠ¡å™¨ (Ctrl+C)

# æ¸…ç†ç¼“å­˜
cd d:\wan-qing\wq-web
rm -r -force .umi
rm -r -force node_modules\.cache

# é‡æ–°å¯åŠ¨
pnpm dev
```

### 2. æ¸…é™¤æµè§ˆå™¨æ•°æ®

æ‰“å¼€æµè§ˆå™¨ â†’ F12 â†’ Console â†’ æ‰§è¡Œï¼š
```javascript
localStorage.clear();
location.reload();
```

### 3. ç™»å½•æµ‹è¯•

è®¿é—® `http://localhost:8000/login`

ä½¿ç”¨è´¦å·ï¼š`admin` / `123456`

### 4. æŸ¥çœ‹ç»“æœ

#### Console æ—¥å¿—

**ç™»å½•æ—¶åº”è¯¥çœ‹åˆ°**ï¼š
```
âš ï¸ è¯·æ±‚æ‹¦æˆªå™¨: æ²¡æœ‰ token { url: "/api/admin/auth/login" }
ğŸ“¥ å“åº”æ‹¦æˆªå™¨: { status: 200 }
ç™»å½•æˆåŠŸï¼Œtoken å·²ä¿å­˜: {...}

âœ… è¯·æ±‚æ‹¦æˆªå™¨: æ·»åŠ  token { url: "/api/admin/auth/info", ... }
ğŸ“¥ å“åº”æ‹¦æˆªå™¨: { status: 200 }
```

#### Network è¯·æ±‚

ç‚¹å‡» `/api/admin/auth/info` è¯·æ±‚ â†’ Headers â†’ Request Headers

**å¿…é¡»åŒ…å«**ï¼š
```
Authorization: Bearer eyJhbGciOiJIUzUxMiJ9.eyJ0b2tlblR5cGUiOiJhZG1pbiIsInVzZXJJZCI6IjE3Njk3NTQzMzA4MzFfOTA3MCIsInVzZXJuYW1lIjoiYWRtaW4iLCJzdWIiOiIxNzY5NzU0MzMwODMxXzkwNzAiLCJpYXQiOjE3Njk3NTQ3ODIsImV4cCI6MTc3MDM1OTU4MiwiaXNzIjoid2FucWluZyJ9...
```

#### API å“åº”

åº”è¯¥è¿”å› **200**ï¼š
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "_id": "1769754330831_9070",
    "username": "admin",
    "realName": "ç³»ç»Ÿç®¡ç†å‘˜",
    ...
  }
}
```

## âŒ ä¸åº”è¯¥å‡ºç°çš„é”™è¯¯

- âŒ `register failed, invalid key requestConfig`
- âŒ `request is not a function`
- âŒ `MissingRequestHeaderException`
- âŒ `Network Error`ï¼ˆå¦‚æœåç«¯æ­£å¸¸è¿è¡Œï¼‰

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: Console ä¸­æ²¡æœ‰æ‹¦æˆªå™¨æ—¥å¿—

**åŸå› **ï¼šæœåŠ¡å™¨æ²¡æœ‰æ­£ç¡®é‡å¯æˆ–ç¼“å­˜æœªæ¸…ç†

**è§£å†³**ï¼š
```bash
# å®Œå…¨æ¸…ç†
cd d:\wan-qing\wq-web
rm -r -force .umi
rm -r -force node_modules\.cache
pnpm dev
```

### é—®é¢˜ 2: æ—¥å¿—æ˜¾ç¤º"æ²¡æœ‰ token"ä½† localStorage ä¸­æœ‰ token

**åŸå› **ï¼šæµè§ˆå™¨ç¼“å­˜äº†æ—§çš„ä»£ç 

**è§£å†³**ï¼š
- ç¡¬åˆ·æ–° (Ctrl+Shift+R)
- æˆ–ä½¿ç”¨æ— ç—•æ¨¡å¼æµ‹è¯•

### é—®é¢˜ 3: Network Error

**æ£€æŸ¥åç«¯æœåŠ¡**ï¼š
```bash
# ç¡®è®¤åç«¯æœåŠ¡è¿è¡Œåœ¨ 8080 ç«¯å£
curl http://localhost:8080/api/admin/auth/login
```

### é—®é¢˜ 4: ä»ç„¶æŠ¥ MissingRequestHeaderException

**æ‰‹åŠ¨éªŒè¯**ï¼š
```javascript
// åœ¨æµè§ˆå™¨ Console ä¸­æ‰§è¡Œ
console.log('Token:', localStorage.getItem('accessToken'));
console.log('Headers:', {
  Authorization: `Bearer ${localStorage.getItem('accessToken')}`
});
```

## ğŸ“Š å®Œæ•´æµç¨‹

```
1. ç”¨æˆ·è®¿é—®ç™»å½•é¡µ
   â†“
2. è¾“å…¥è´¦å·å¯†ç ç‚¹å‡»ç™»å½•
   â†“
3. Login ç»„ä»¶è°ƒç”¨ login() å‡½æ•°
   â†“
4. request('/api/admin/auth/login', { method: 'POST', data: {...} })
   â†“
5. è§¦å‘ .umirc.ts ä¸­çš„è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆç¬¬1æ¬¡ï¼‰
   console.log('âš ï¸ è¯·æ±‚æ‹¦æˆªå™¨: æ²¡æœ‰ token')
   â†“
6. å‘é€è¯·æ±‚åˆ°åç«¯ï¼ˆæ—  tokenï¼‰
   â†“
7. åç«¯è¿”å›ç™»å½•æˆåŠŸå’Œ token
   â†“
8. Login ç»„ä»¶ä¿å­˜ token åˆ° localStorage
   console.log('ç™»å½•æˆåŠŸï¼Œtoken å·²ä¿å­˜')
   â†“
9. è°ƒç”¨ refresh() åˆå§‹åŒ–çŠ¶æ€
   â†“
10. app.tsx çš„ getInitialState() æ‰§è¡Œ
    â†“
11. è°ƒç”¨ getCurrentUser()
    â†“
12. request('/api/admin/auth/info', { method: 'GET' })
    â†“
13. è§¦å‘ .umirc.ts ä¸­çš„è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆç¬¬2æ¬¡ï¼‰
    console.log('âœ… è¯·æ±‚æ‹¦æˆªå™¨: æ·»åŠ  token')
    æ·»åŠ  Authorization: Bearer {token}
    â†“
14. å‘é€è¯·æ±‚åˆ°åç«¯ï¼ˆå¸¦ tokenï¼‰âœ…
    â†“
15. åç«¯éªŒè¯ tokenï¼Œè¿”å›ç”¨æˆ·ä¿¡æ¯
    â†“
16. è·³è½¬åˆ°é¦–é¡µ
```

## ğŸ“ é…ç½®æ–‡ä»¶å¯¹æ¯”

| æ–‡ä»¶ | ç”¨é€” | æ˜¯å¦é…ç½® request |
|------|------|-----------------|
| `.umirc.ts` | ç¼–è¯‘æ—¶é…ç½® | âœ… æ˜¯ |
| `src/app.tsx` | è¿è¡Œæ—¶é…ç½® | âŒ å¦ |
| `src/request.ts` | çº¦å®šå¼é…ç½® | âŒ å·²åˆ é™¤ |

## âœ… éªŒè¯æ¸…å•

- [ ] TypeScript ç¼–è¯‘é€šè¿‡
- [ ] æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨ï¼Œæ— æŠ¥é”™
- [ ] Console ä¸­æœ‰æ‹¦æˆªå™¨æ—¥å¿—
- [ ] localStorage ä¸­æœ‰ accessToken
- [ ] Network ä¸­ Request Headers åŒ…å« Authorization
- [ ] API è¿”å› 200 è€Œä¸æ˜¯ 500
- [ ] ç™»å½•åèƒ½æ­£å¸¸è¿›å…¥é¦–é¡µ

## ğŸ¯ æ€»ç»“

**æ­£ç¡®åšæ³•**ï¼š
1. âœ… åœ¨ `.umirc.ts` çš„ `request` é…ç½®ä¸­å®šä¹‰æ‹¦æˆªå™¨
2. âœ… æ‹¦æˆªå™¨å‡½æ•°ä¼šè‡ªåŠ¨åœ¨è¿è¡Œæ—¶æ‰§è¡Œï¼Œå¯ä»¥è®¿é—® `localStorage`
3. âœ… ä½¿ç”¨ `typeof localStorage !== 'undefined'` æ£€æŸ¥ç¯å¢ƒ

**é”™è¯¯åšæ³•**ï¼š
1. âŒ åœ¨ `app.tsx` ä¸­å¯¼å‡º `requestConfig`ï¼ˆä¼šæŠ¥é”™ï¼‰
2. âŒ åœ¨ `app.tsx` ä¸­å¯¼å‡º `request`ï¼ˆä¼šå†²çªï¼‰
3. âŒ åˆ›å»ºå•ç‹¬çš„ `src/request.ts` æ–‡ä»¶å¯¼å‡ºé…ç½®ï¼ˆä¸å¿…è¦ï¼‰

**è®°ä½**ï¼š`.umirc.ts` ä¸­çš„å‡½æ•°é…ç½®ä¼šåœ¨è¿è¡Œæ—¶æ‰§è¡Œï¼
