# Authorization Header æœªæºå¸¦ - ç»ˆæä¿®å¤

## âœ… æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

**é—®é¢˜æ ¹æº**: `.umirc.ts` æ˜¯ç¼–è¯‘æ—¶é…ç½®ï¼Œæ— æ³•è®¿é—®æµè§ˆå™¨è¿è¡Œæ—¶çš„ `localStorage`

**æ­£ç¡®æ–¹æ¡ˆ**: ä½¿ç”¨ umi/max çš„çº¦å®šå¼é…ç½®ï¼Œåˆ›å»º `src/request.ts` æ–‡ä»¶

## ğŸ“ å·²ä¿®æ”¹çš„æ–‡ä»¶

### 1. æ–°å»º `src/request.ts`

```typescript
import { RequestConfig } from '@umijs/max';

export const request: RequestConfig = {
  timeout: 60000,
  requestInterceptors: [
    (config: any, { getUrl }: { getUrl: () => string }) => {
      const accessToken = localStorage.getItem('accessToken');

      if (accessToken) {
        config.headers = {
          ...config.headers,
          Authorization: `Bearer ${accessToken}`,
        };
      }

      return config;
    },
  ],
};
```

### 2. æ›´æ–° `.umirc.ts`

ç§»é™¤äº† `request` é…ç½®ï¼Œè®© umi è‡ªåŠ¨ä½¿ç”¨ `src/request.ts`

### 3. ä¿ç•™ `src/app.tsx`

åªåŒ…å«è¿è¡Œæ—¶é…ç½®ï¼ˆgetInitialStateã€onRouteChange ç­‰ï¼‰

## ğŸš€ é‡å¯æ­¥éª¤ï¼ˆé‡è¦ï¼ï¼‰

### Windows PowerShell/CMD

```bash
# 1. åœæ­¢å½“å‰æœåŠ¡å™¨ (Ctrl+C)

# 2. æ¸…ç†ç¼“å­˜
cd d:\wan-qing\wq-web
rm -r -force .umi
rm -r -force node_modules\.cache

# 3. é‡æ–°å¯åŠ¨
pnpm dev
```

### æˆ–ä½¿ç”¨ Git Bash

```bash
cd /d/wan-qing/wq-web
rm -rf .umi
rm -rf node_modules/.cache
pnpm dev
```

## ğŸ” éªŒè¯æ­¥éª¤

### 1. æ¸…é™¤æµè§ˆå™¨æ•°æ®

æ‰“å¼€å¼€å‘è€…å·¥å…· (F12)ï¼Œåœ¨ Console ä¸­æ‰§è¡Œï¼š

```javascript
localStorage.clear();
sessionStorage.clear();
location.reload();
```

### 2. æ‰§è¡Œç™»å½•

è®¿é—® `http://localhost:8000/login`ï¼Œä½¿ç”¨ admin / 123456 ç™»å½•

### 3. æŸ¥çœ‹ Console æ—¥å¿—

**å¿…é¡»çœ‹åˆ°**:

```
âœ… è¯·æ±‚æ‹¦æˆªå™¨: æ·»åŠ  token {
  url: "/api/admin/auth/login",
  hasToken: false,
  tokenPrefix: "..."
}

âœ… è¯·æ±‚æ‹¦æˆªå™¨: æ·»åŠ  token {
  url: "/api/admin/auth/info",
  hasToken: true,
  tokenPrefix: "eyJhbGciOiJIUzUxMiJ9...."
}
```

### 4. æŸ¥çœ‹ Network è¯·æ±‚

å¼€å‘è€…å·¥å…· â†’ Network æ ‡ç­¾ â†’ æ‰¾åˆ° `/api/admin/auth/info`

**Request Headers å¿…é¡»åŒ…å«**:

```
Authorization: Bearer eyJhbGciOiJIUzUxMiJ9.eyJ0b2tlblR5cGUiOiJhZG1pbiIsInVzZXJJZCI6IjE3Njk3NTQzMzA4MzFfOTA3MCIsInVzZXJuYW1lIjoiYWRtaW4iLCJzdWIiOiIxNzY5NzU0MzMwODMxXzkwNzAiLCJpYXQiOjE3Njk3NTQ3ODIsImV4cCI6MTc3MDM1OTU4MiwiaXNzIjoid2FucWluZyJ9...
```

### 5. éªŒè¯å“åº”

åº”è¯¥è¿”å› **200** è€Œä¸æ˜¯ 500ï¼š

```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "_id": "1769754330831_9070",
    "username": "admin",
    "realName": "ç³»ç»Ÿç®¡ç†å‘˜",
    ...
  }
}
```

## ğŸ¯ umi/max çº¦å®šå¼é…ç½®

umi/max ä¼šè‡ªåŠ¨è¯†åˆ«ä»¥ä¸‹æ–‡ä»¶ï¼š

| æ–‡ä»¶ä½ç½® | ç”¨é€” | æ˜¯å¦å¿…éœ€ |
|---------|------|---------|
| `src/app.tsx` | è¿è¡Œæ—¶é…ç½® | âœ… |
| `src/request.ts` | Request é…ç½® | âŒ (å¯é€‰) |
| `.umirc.ts` | ç¼–è¯‘æ—¶é…ç½® | âœ… |

**é…ç½®ä¼˜å…ˆçº§**:
- `src/request.ts` > `.umirc.ts` ä¸­çš„ `request` é…ç½®
- è¿è¡Œæ—¶é…ç½® (`app.tsx`) > ç¼–è¯‘æ—¶é…ç½® (`.umirc.ts`)

## ğŸ“Š å®Œæ•´çš„è¯·æ±‚æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»ç™»å½•
   â†“
2. è°ƒç”¨ POST /api/admin/auth/login
   â†“
3. åç«¯è¿”å› { code: 200, data: { accessToken, refreshToken, admin } }
   â†“
4. ç™»å½•é¡µé¢ä¿å­˜ token åˆ° localStorage
   console.log('ç™»å½•æˆåŠŸï¼Œtoken å·²ä¿å­˜')
   â†“
5. è°ƒç”¨ refresh() åˆ·æ–°åˆå§‹çŠ¶æ€
   â†“
6. app.tsx çš„ getInitialState() æ‰§è¡Œ
   â†“
7. è°ƒç”¨ GET /api/admin/auth/info
   â†“
8. src/request.ts çš„è¯·æ±‚æ‹¦æˆªå™¨æ‰§è¡Œ âœ…
   â†“
9. æ·»åŠ  Authorization: Bearer {token}
   â†“
10. åç«¯æ¥æ”¶ tokenï¼ŒéªŒè¯é€šè¿‡
   â†“
11. è¿”å›ç”¨æˆ·ä¿¡æ¯ { code: 200, data: {...} }
   â†“
12. è·³è½¬åˆ°é¦–é¡µ
```

## âš ï¸ å¦‚æœä»ç„¶æ²¡æœ‰æºå¸¦ token

### æ£€æŸ¥æ¸…å•

1. **âœ… æœåŠ¡å™¨å·²é‡å¯**
   ```bash
   # æ£€æŸ¥ .umi ç›®å½•æ˜¯å¦é‡æ–°ç”Ÿæˆ
   ls -la .umi
   ```

2. **âœ… æµè§ˆå™¨ç¼“å­˜å·²æ¸…é™¤**
   ```javascript
   // Console ä¸­æ‰§è¡Œ
   localStorage.clear();
   location.reload();
   ```

3. **âœ… src/request.ts æ–‡ä»¶å­˜åœ¨**
   ```bash
   ls src/request.ts
   # åº”è¯¥æ˜¾ç¤ºæ–‡ä»¶å­˜åœ¨
   ```

4. **âœ… .umirc.ts ä¸­æ²¡æœ‰ request é…ç½®**
   ```bash
   grep -n "request:" .umirc.ts
   # åº”è¯¥åªæœ‰æ³¨é‡Š # request é…ç½®å·²ç§»åˆ° src/request.ts
   ```

5. **âœ… localStorage ä¸­æœ‰ token**
   ```javascript
   console.log(localStorage.getItem('accessToken'));
   // åº”è¯¥è¾“å‡º token å­—ç¬¦ä¸²ï¼Œä¸æ˜¯ null
   ```

6. **âœ… Console ä¸­æœ‰æ‹¦æˆªå™¨æ—¥å¿—**
   ```
   âœ… è¯·æ±‚æ‹¦æˆªå™¨: æ·»åŠ  token
   ```

### æ‰‹åŠ¨éªŒè¯æ‹¦æˆªå™¨

åœ¨æµè§ˆå™¨ Console ä¸­æ‰§è¡Œï¼š

```javascript
// æ£€æŸ¥ request é…ç½®æ˜¯å¦åŠ è½½
import { request } from '@umijs/max';

console.log('request å‡½æ•°:', request);

// å‘èµ·æµ‹è¯•è¯·æ±‚
request('/api/admin/auth/info', {
  method: 'GET',
})
  .then(res => console.log('âœ… æˆåŠŸ:', res))
  .catch(err => console.error('âŒ å¤±è´¥:', err));
```

## ğŸ“ è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹å®é™…å‘é€çš„è¯·æ±‚å¤´

```javascript
// ä½¿ç”¨åŸç”Ÿ fetch å¯¹æ¯”
fetch('/api/admin/auth/info', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
  }
})
  .then(res => {
    console.log('âœ… åŸç”Ÿ fetch æˆåŠŸ');
    return res.json();
  })
  .then(data => console.log('æ•°æ®:', data))
  .catch(err => console.error('å¤±è´¥:', err));
```

### 2. ç›‘æ§æ‰€æœ‰è¯·æ±‚

åœ¨ `src/request.ts` çš„æ‹¦æˆªå™¨ä¸­æ·»åŠ æ›´å¤šæ—¥å¿—ï¼š

```typescript
requestInterceptors: [
  (config: any) => {
    console.log('=== è¯·æ±‚æ‹¦æˆªå™¨ ===');
    console.log('URL:', config.url);
    console.log('Headers:', config.headers);
    console.log('Token:', localStorage.getItem('accessToken')?.substring(0, 30));
    console.log('==================');

    const accessToken = localStorage.getItem('accessToken');
    if (accessToken) {
      config.headers = {
        ...config.headers,
        Authorization: `Bearer ${accessToken}`,
      };
    }
    return config;
  },
]
```

## ğŸ“ å…³é”®è¦ç‚¹

1. **`src/request.ts` æ˜¯ umi/max çš„çº¦å®šå¼é…ç½®æ–‡ä»¶**
2. **ä¿®æ”¹æ­¤æ–‡ä»¶åå¿…é¡»é‡å¯å¼€å‘æœåŠ¡å™¨**
3. **`.umirc.ts` ä¸­çš„ request é…ç½®ä¼šè¦†ç›– `src/request.ts`**
4. **æµè§ˆå™¨ç¼“å­˜å¯èƒ½å¯¼è‡´é…ç½®æœªæ›´æ–°**

## âœ… æˆåŠŸæ ‡å¿—

- [ ] Console ä¸­æœ‰æ‹¦æˆªå™¨æ—¥å¿—è¾“å‡º
- [ ] Network ä¸­ Request Headers åŒ…å« Authorization
- [ ] API è¿”å› 200 è€Œä¸æ˜¯ 500
- [ ] æ²¡æœ‰ "MissingRequestHeaderException" é”™è¯¯
- [ ] ç™»å½•åèƒ½æ­£å¸¸è¿›å…¥é¦–é¡µ
