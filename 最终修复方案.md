# ä¿®å¤ "request is not a function" é”™è¯¯

## âœ… é—®é¢˜å·²è§£å†³

**é—®é¢˜**: `src/request.ts` ä¸­çš„ `export const request` ä¸ umi/max å¯¼å…¥çš„ `request` å‡½æ•°å‘½åå†²çª

**è§£å†³**: æ”¹ä¸º `export const requestConfig`

## ğŸ“ å½“å‰é…ç½®

### 1. `src/request.ts`
```typescript
import { RequestConfig } from '@umijs/max';

// âœ… ä½¿ç”¨ requestConfig é¿å…å‘½åå†²çª
export const requestConfig: RequestConfig = {
  timeout: 60000,
  requestInterceptors: [
    (config: any) => {
      const accessToken = localStorage.getItem('accessToken');
      if (accessToken) {
        config.headers = {
          ...config.headers,
          Authorization: `Bearer ${accessToken}`,
        };
      }
      return config;
    },
  ],
};
```

### 2. `.umirc.ts`
```typescript
import { defineConfig } from '@umijs/max';
import { requestConfig } from './src/request';

export default defineConfig({
  // ...
  request: requestConfig,  // âœ… å¯¼å…¥é…ç½®å¯¹è±¡
  // ...
});
```

## ğŸš€ æµ‹è¯•æ­¥éª¤

### 1. å®Œå…¨æ¸…ç†å¹¶é‡å¯

```bash
# åœæ­¢å½“å‰æœåŠ¡å™¨ (Ctrl+C)

# æ¸…ç†ç¼“å­˜
cd d:\wan-qing\wq-web
rm -r -force .umi
rm -r -force node_modules\.cache

# é‡æ–°å¯åŠ¨
pnpm dev
```

### 2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

æ‰“å¼€æµè§ˆå™¨ (F12) â†’ Console â†’ æ‰§è¡Œï¼š
```javascript
localStorage.clear();
location.reload();
```

### 3. æµ‹è¯•ç™»å½•

è®¿é—® `http://localhost:8000/login`

**ä¸åº”è¯¥å†å‡ºç°**ï¼š
- âŒ `request is not a function`
- âŒ `MissingRequestHeaderException`

**åº”è¯¥çœ‹åˆ°**ï¼š
- âœ… é¡µé¢æ­£å¸¸åŠ è½½
- âœ… ç™»å½•åŠŸèƒ½æ­£å¸¸
- âœ… Console æœ‰æ‹¦æˆªå™¨æ—¥å¿—

### 4. éªŒè¯ Token æºå¸¦

Network æ ‡ç­¾ â†’ æ‰¾åˆ° `/api/admin/auth/info` â†’ æŸ¥çœ‹ Request Headers

**å¿…é¡»åŒ…å«**ï¼š
```
Authorization: Bearer eyJhbGciOiJIUzUxMiJ9...
```

## ğŸ” å¦‚æœè¿˜æœ‰é—®é¢˜

### é—®é¢˜ A: ä»ç„¶æŠ¥ "request is not a function"

**æ£€æŸ¥**ï¼š
```bash
# ç¡®ä¿ src/request.ts ä½¿ç”¨çš„æ˜¯ requestConfig
grep "export const request" src/request.ts
# åº”è¯¥è¿”å›: export const requestConfig

# ç¡®ä¿ .umirc.ts æ­£ç¡®å¯¼å…¥
grep "import.*requestConfig" .umirc.ts
# åº”è¯¥è¿”å›: import { requestConfig } from './src/request';
```

### é—®é¢˜ B: Token ä»ç„¶æ²¡æœ‰æºå¸¦

**åŸå› **: æµè§ˆå™¨ç¼“å­˜äº†æ—§çš„ä»£ç 

**è§£å†³**:
1. ç¡¬åˆ·æ–°æµè§ˆå™¨ (Ctrl+Shift+R)
2. æˆ–ä½¿ç”¨æ— ç—•æ¨¡å¼æµ‹è¯•
3. æ¸…é™¤æ‰€æœ‰æµè§ˆå™¨æ•°æ®

### é—®é¢˜ C: é¡µé¢æ— æ³•åŠ è½½

**æ£€æŸ¥**ï¼š
```bash
# æŸ¥çœ‹å¼€å‘æœåŠ¡å™¨æ˜¯å¦æœ‰é”™è¯¯
# æ£€æŸ¥ .umi ç›®å½•æ˜¯å¦é‡æ–°ç”Ÿæˆ
ls -la .umi
```

## ğŸ“Š å®Œæ•´æµç¨‹

```
ç”¨æˆ·è®¿é—®ç™»å½•é¡µ
    â†“
Login ç»„ä»¶å¯¼å…¥: import { login } from '@/services/auth';
    â†“
services/auth.ts: ä½¿ç”¨ import { request } from '@umijs/max';
    â†“
request å‡½æ•°ç”± umi/max æä¾›
    â†“
é…ç½®æ¥è‡ª .umirc.ts ä¸­çš„ request: requestConfig
    â†“
requestConfig å®šä¹‰åœ¨ src/request.ts
    â†“
è¯·æ±‚æ‹¦æˆªå™¨åœ¨è¿è¡Œæ—¶æ‰§è¡Œ
    â†“
ä» localStorage è¯»å– accessToken
    â†“
æ·»åŠ  Authorization header âœ…
    â†“
å‘é€åˆ°åç«¯
```

## âœ… éªŒè¯æ¸…å•

- [ ] TypeScript ç¼–è¯‘é€šè¿‡ (`npx tsc --noEmit`)
- [ ] æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨ï¼Œæ— æŠ¥é”™
- [ ] é¡µé¢æ­£å¸¸åŠ è½½ï¼Œæ²¡æœ‰ "request is not a function"
- [ ] localStorage ä¸­æœ‰ token
- [ ] Network ä¸­ Request Headers åŒ…å« Authorization
- [ ] API è¿”å› 200 è€Œä¸æ˜¯ 500

## ğŸ¯ å…³é”®ç‚¹

1. **å‘½åå†²çª**: `export const request` ä¼šå¯¼è‡´ä¸ umi/max çš„ `request` å‡½æ•°å†²çª
2. **ä½¿ç”¨ requestConfig**: å¯¼å‡º `requestConfig` å¹¶åœ¨ `.umirc.ts` ä¸­å¯¼å…¥
3. **è¿è¡Œæ—¶æ‰§è¡Œ**: è™½ç„¶åœ¨ `.umirc.ts` ä¸­å¯¼å…¥é…ç½®ï¼Œä½†æ‹¦æˆªå™¨å‡½æ•°åœ¨è¿è¡Œæ—¶æ‰§è¡Œï¼Œå¯ä»¥è®¿é—® localStorage
4. **å®Œå…¨é‡å¯**: ä¿®æ”¹ `.umirc.ts` åå¿…é¡»å®Œå…¨æ¸…ç†ç¼“å­˜å¹¶é‡å¯

## ğŸ“ é…ç½®æ€»ç»“

| æ–‡ä»¶ | å†…å®¹ | ä½œç”¨ |
|------|------|------|
| `src/request.ts` | `export const requestConfig` | å®šä¹‰è¯·æ±‚é…ç½® |
| `.umirc.ts` | `request: requestConfig` | åº”ç”¨è¯·æ±‚é…ç½® |
| `src/app.tsx` | è¿è¡Œæ—¶é…ç½® | getInitialState ç­‰ |
| `src/services/auth.ts` | `import { request }` | ä½¿ç”¨ request å‡½æ•° |

æ‰€æœ‰é…ç½®å·²å®Œæˆï¼Œç°åœ¨å¯ä»¥æµ‹è¯•äº†ï¼
