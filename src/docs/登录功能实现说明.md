# 登录功能实现说明

## 已实现的功能

### 1. 登录接口对接

#### 接口信息
- **接口地址**: `POST /api/admin/auth/login`
- **请求参数**:
  ```json
  {
    "username": "admin",
    "password": "123456"
  }
  ```

#### 响应处理
```typescript
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "accessToken": "eyJhbGciOiJIUzUxMiJ9...",
    "refreshToken": "eyJhbGciOiJIUzUxMiJ9...",
    "tokenType": "Bearer",
    "expiresIn": 604800,
    "admin": {
      "id": "1769754330831_9070",
      "username": "admin",
      "realName": "系统管理员",
      "role": 1,
      "roleDescription": "管理员"
      // ...
    }
  }
}
```

### 2. Token自动携带机制

**位置**: `src/app.tsx` - 请求拦截器 (第77-92行)

```typescript
requestInterceptors: [
  (config: any) => {
    const accessToken = localStorage.getItem('accessToken');

    if (accessToken) {
      config.headers = {
        ...config.headers,
        Authorization: `Bearer ${accessToken}`,
      };
    }

    return config;
  },
]
```

**功能**:
- 自动从 localStorage 读取 `accessToken`
- 每个请求自动添加 `Authorization: Bearer {token}` 请求头
- 无需手动处理token

### 3. 401自动刷新Token机制

**位置**: `src/app.tsx` - 响应拦截器 (第93-173行)

**工作流程**:

```
┌─────────────────┐
│  发送API请求    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  收到401响应    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐    是    ┌──────────────────┐
│ 是否有          │────────▶│ 跳转登录页        │
│ refreshToken?   │         │ 清除认证信息      │
└────────┬────────┘         └──────────────────┘
         │否
         ▼
┌─────────────────┐    是    ┌──────────────────┐
│ 是否正在刷新    │────────▶│ 请求加入队列     │
│ Token?          │         │ 等待刷新完成     │
└────────┬────────┘         └──────────────────┘
         │否
         ▼
┌─────────────────┐
│ 调用刷新接口    │
│ /api/admin/auth/│
│ refresh         │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
   成功      失败
    │         │
    ▼         ▼
┌────────┐ ┌──────┐
│保存新token││跳转登录│
│重试原请求││清除认证│
└────────┘ └──────┘
```

**特性**:
- 防止并发刷新：使用 `isRefreshing` 标志
- 请求队列：刷新期间的请求自动加入队列
- 自动重试：刷新成功后自动重新发送失败的请求
- 优雅降级：刷新失败则清除认证信息并跳转登录

### 4. 业务错误码处理

**位置**: `src/app.tsx` - 响应拦截器 (第156-170行)

```typescript
// 检查响应数据中的业务错误码
const clone = response.clone();
const data = await clone.json();

if (data && data.code !== undefined && data.code !== 200) {
  return Promise.reject({
    code: data.code,
    message: data.message || '请求失败',
    data: data.data,
  });
}
```

**处理场景**:
- 用户名或密码错误: `code: 500, message: "用户名或密码错误"`
- 账户已被禁用: `code: 500, message: "账户已被禁用"`
- 账户已被锁定: `code: 500, message: "账户已被锁定，请联系管理员"`

### 5. 统一错误处理

**位置**: `src/app.tsx` - errorHandler (第175-206行)

| HTTP状态码 | 错误提示 |
|-----------|---------|
| 401 | 已在响应拦截器中处理（自动刷新或跳转登录）|
| 403 | 没有权限访问 |
| 404 | 请求的资源不存在 |
| 500 | 服务器内部错误 |
| 502 | 网关错误 |
| 503 | 服务不可用 |
| 504 | 网关超时 |
| 网络错误 | 网络连接异常，请检查网络 |

### 6. 路由守卫

**位置**: `src/app.tsx` - onRouteChange (第209-224行)

**功能**:
- 自动检查用户是否登录
- 未登录用户访问受保护页面时自动跳转到登录页
- 登录页面不受此限制

## 本地存储说明

登录后，以下数据会保存到 localStorage:

| 键名 | 类型 | 说明 |
|------|------|------|
| `accessToken` | String | 访问令牌，7天有效 |
| `refreshToken` | String | 刷新令牌，30天有效 |
| `adminInfo` | JSON String | 管理员信息对象 |

## 使用示例

### 登录
```typescript
// 在登录页面
const res = await login({
  username: 'admin',
  password: '123456'
});

// 响应数据会自动保存到 localStorage
// res.data.accessToken -> localStorage.accessToken
// res.data.refreshToken -> localStorage.refreshToken
// res.data.admin -> localStorage.adminInfo
```

### 发起需要认证的请求
```typescript
// 使用 umi 的 request，token会自动添加
import { request } from '@umijs/max';

const data = await request('/api/admin/auth/info', {
  method: 'GET',
});
// 自动添加 header: Authorization: Bearer {accessToken}
```

### 登出
```typescript
import { history } from '@umijs/max';

// 清除本地存储
localStorage.removeItem('accessToken');
localStorage.removeItem('refreshToken');
localStorage.removeItem('adminInfo');

// 跳转登录页
history.push('/login');
```

## 接口列表

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 登录 | POST | /api/admin/auth/login | 用户名密码登录 |
| 登出 | POST | /api/admin/auth/logout | 退出登录 |
| 获取用户信息 | GET | /api/admin/auth/info | 需要认证 |
| 刷新Token | POST | /api/admin/auth/refresh | 使用refreshToken获取新token |
| 验证Token | POST | /api/admin/auth/validate | 验证token是否有效 |

## 测试步骤

1. 启动项目: `pnpm dev`
2. 访问: `http://localhost:8000`
3. 自动跳转到登录页
4. 输入用户名和密码（例如: admin / 123456）
5. 点击登录
6. 检查浏览器开发者工具:
   - Application -> Local Storage -> 查看是否有 accessToken, refreshToken, adminInfo
   - Network -> 查看后续请求是否携带 Authorization header
7. 等待token过期（可手动修改accessToken测试刷新机制）

## 注意事项

1. **Token刷新机制**: 当收到401响应时会自动刷新，无需手动处理
2. **并发请求处理**: 多个请求同时收到401时，只会发起一次刷新请求，其他请求会排队等待
3. **刷新失败处理**: 如果refreshToken也过期了，会自动清除所有认证信息并跳转登录页
4. **路由保护**: 未登录用户访问任何非登录页面都会自动跳转到登录页

## 配置文件

**代理配置** (`.umirc.ts`):
```typescript
proxy: {
  '/api': {
    target: 'http://localhost:8080',
    changeOrigin: true,
  },
}
```

确保后端服务运行在 `http://localhost:8080`
