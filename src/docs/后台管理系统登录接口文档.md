# 后台管理系统登录接口文档

## 接口概览

| 接口名称 | 请求方式 | 接口地址 | 是否需要认证 |
|---------|---------|---------|------------|
| 管理员登录 | POST | /api/admin/auth/login | 否 |
| 刷新Token | POST | /api/admin/auth/refresh | 否 |
| 验证Token | POST | /api/admin/auth/validate | 否 |
| 获取管理员信息 | GET | /api/admin/auth/info | 是 |
| 退出登录 | POST | /api/admin/auth/logout | 否 |

---

## 1. 管理员登录

### 接口信息
- **接口地址**：`POST /api/admin/auth/login`
- **接口描述**：通过用户名密码登录后台管理系统
- **Content-Type**：`application/json`

### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例值 |
|--------|------|------|------|--------|
| username | String | 是 | 管理员用户名 | admin |
| password | String | 是 | 管理员密码 | 123456 |

### 请求示例
```json
{
  "username": "admin",
  "password": "123456"
}
```

### 响应参数

| 参数名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| code | Integer | 响应状态码 | 200 |
| message | String | 响应消息 | "登录成功" |
| data | Object | 响应数据 | - |

### data 对象结构

| 参数名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| accessToken | String | 访问令牌（用于后续请求） | "eyJhbGciOiJIUzI1NiJ9..." |
| refreshToken | String | 刷新令牌（用于获取新token） | "eyJhbGciOiJIUzI1NiJ9..." |
| tokenType | String | Token类型 | "Bearer" |
| expiresIn | Long | Token过期时间（秒） | 604800 |
| admin | Object | 管理员信息 | - |

### admin 对象结构

| 参数名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| id | String | 管理员ID | "1703123456789_1234" |
| username | String | 用户名 | "admin" |
| realName | String | 真实姓名 | "管理员" |
| phone | String | 手机号 | "13800138000" |
| email | String | 邮箱 | "admin@example.com" |
| avatar | String | 头像URL | "https://example.com/avatar.jpg" |
| role | Integer | 角色代码（0=超级管理员，1=管理员，2=普通管理员） | 1 |
| roleDescription | String | 角色描述 | "管理员" |
| lastLoginTime | String | 最后登录时间 | "2024-01-22T14:30:00" |
| lastLoginIp | String | 最后登录IP | "192.168.1.100" |

### 成功响应示例
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiIxNzAzMTIzNDU2Nzg5XzEyMzQiLCJ0b2tlblR5cGUiOiJhZG1pbiIsInVzZXJuYW1lIjoiYWRtaW4iLCJpYXQiOjE3MDYwMDAwMDAsImV4cCI6MTcwNjYwNDgwMCwiaXNzIjoid3Etc3lzdGVtIn0.xxx",
    "refreshToken": "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiIxNzAzMTIzNDU2Nzg5XzEyMzQiLCJ0b2tlblR5cGUiOiJhZG1pbiIsInVzZXJuYW1lIjoiYWRtaW4iLCJpYXQiOjE3MDYwMDAwMDAsImV4cCI6MTcwODU5MjAwMCwiaXNzIjoid3Etc3lzdGVtIn0.xxx",
    "tokenType": "Bearer",
    "expiresIn": 604800,
    "admin": {
      "id": "1703123456789_1234",
      "username": "admin",
      "realName": "系统管理员",
      "phone": "13800138000",
      "email": "admin@example.com",
      "avatar": "https://example.com/avatar.jpg",
      "role": 1,
      "roleDescription": "管理员",
      "lastLoginTime": "2024-01-22T14:30:00",
      "lastLoginIp": "192.168.1.100"
    }
  }
}
```

### 失败响应示例

**用户名或密码错误**
```json
{
  "code": 500,
  "message": "用户名或密码错误"
}
```

**账户已被禁用**
```json
{
  "code": 500,
  "message": "账户已被禁用"
}
```

**账户已被锁定**
```json
{
  "code": 500,
  "message": "账户已被锁定，请联系管理员"
}
```

---

## 2. 使用Token访问其他接口

登录成功后，后续所有需要认证的接口都需要在请求头中携带 `Authorization`：

### 请求头格式

```
Authorization: Bearer {accessToken}
```

### 请求示例
```bash
GET /api/admin/xxx
Headers:
  Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...
```

---

## 3. 刷新Token

当 `accessToken` 即将过期时，可以使用 `refreshToken` 获取新的访问令牌。

### 接口信息
- **接口地址**：`POST /api/admin/auth/refresh`
- **Content-Type**：`application/json`

### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例值 |
|--------|------|------|------|--------|
| refreshToken | String | 是 | 刷新令牌 | "eyJhbGciOiJIUzI1NiJ9..." |

### 请求示例
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiJ9..."
}
```

### 成功响应示例
```json
{
  "code": 200,
  "message": "Token刷新成功",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiJ9...",
    "tokenType": "Bearer"
  }
}
```

---

## 4. 验证Token

### 接口信息
- **接口地址**：`POST /api/admin/auth/validate`
- **Content-Type**：`application/json`

### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例值 |
|--------|------|------|------|--------|
| token | String | 是 | 完整的token字符串 | "eyJhbGciOiJIUzI1NiJ9..." |

### 成功响应示例
```json
{
  "code": 200,
  "message": "Token有效",
  "data": {
    "valid": true,
    "adminId": "1703123456789_1234",
    "username": "admin",
    "tokenType": "admin"
  }
}
```

---

## 5. 获取当前管理员信息

### 接口信息
- **接口地址**：`GET /api/admin/auth/info`
- **需要认证**：是

### 请求头
```
Authorization: Bearer {accessToken}
```

### 成功响应示例
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "_id": "1703123456789_1234",
    "username": "admin",
    "realName": "系统管理员",
    "phone": "13800138000",
    "email": "admin@example.com",
    "avatar": "https://example.com/avatar.jpg",
    "role": 1,
    "status": 1,
    "lastLoginTime": "2024-01-22T14:30:00",
    "lastLoginIp": "192.168.1.100",
    "createTime": "2024-01-01T10:00:00",
    "updateTime": "2024-01-22T14:30:00"
  }
}
```

---

## 6. 退出登录

### 接口信息
- **接口地址**：`POST /api/admin/auth/logout`
- **需要认证**：否（可选）

### 成功响应示例
```json
{
  "code": 200,
  "message": "退出成功"
}
```

---

## 完整使用流程示例

### 1. 登录
```bash
curl -X POST http://localhost:8080/api/admin/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "123456"
  }'
```

### 2. 访问需要认证的接口
```bash
curl -X GET http://localhost:8080/api/admin/auth/info \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiJ9..."
```

### 3. 刷新Token
```bash
curl -X POST http://localhost:8080/api/admin/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{
    "refreshToken": "eyJhbGciOiJIUzI1NiJ9..."
  }'
```

---

## 管理员角色说明

| 角色代码 | 角色名称 | 说明 |
|---------|---------|------|
| 0 | 超级管理员 | 拥有所有权限 |
| 1 | 管理员 | 常规管理权限 |
| 2 | 普通管理员 | 基础管理权限 |

## 管理员状态说明

| 状态代码 | 状态名称 | 说明 |
|---------|---------|------|
| 0 | 禁用 | 账户已禁用，无法登录 |
| 1 | 正常 | 账户正常，可以登录 |
| 2 | 锁定 | 账户已锁定，无法登录（连续5次登录失败） |

## Token说明

### Token类型区分

系统支持两种Token类型：

- **用户端Token（user）**：用于微信小程序前端
  - 认证路径：`/api/auth/**`
  - Payload包含：`userId`, `openid`, `tokenType`

- **管理端Token（admin）**：用于后台管理系统
  - 认证路径：`/api/admin/**`
  - Payload包含：`userId`, `username`, `tokenType`

### Token有效期

| Token类型 | 有效期 | 说明 |
|----------|--------|------|
| accessToken | 7天（604800秒） | 用于访问业务接口 |
| refreshToken | 30天 | 用于获取新的accessToken |

## 注意事项

1. **密码安全**：密码使用BCrypt加密存储，传输时建议使用HTTPS
2. **Token存储**：前端应安全存储Token（推荐使用localStorage或sessionStorage）
3. **Token刷新**：建议在accessToken过期前1小时内使用refreshToken刷新
4. **登录保护**：连续5次登录失败后账户会被自动锁定
5. **Token验证**：系统会自动验证Token类型和有效性，防止跨系统使用
6. **IP记录**：每次登录都会记录IP地址和登录时间
7. **请求头格式**：`Authorization: Bearer {token}`（注意Bearer后必须有空格）
8. **错误处理**：所有错误都会返回统一的错误消息，便于前端提示用户

## 错误码说明

| 错误码 | 说明 |
|-------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 401 | 未授权或Token无效 |
| 500 | 服务器内部错误 |

## 前端集成建议

```javascript
// 1. 登录
async function login(username, password) {
  const response = await fetch('/api/admin/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  });
  const result = await response.json();

  if (result.code === 200) {
    // 保存Token
    localStorage.setItem('accessToken', result.data.accessToken);
    localStorage.setItem('refreshToken', result.data.refreshToken);
    localStorage.setItem('adminInfo', JSON.stringify(result.data.admin));
    return result.data;
  }
  throw new Error(result.message);
}

// 2. 访问需要认证的接口
async function fetchWithAuth(url, options = {}) {
  const token = localStorage.getItem('accessToken');
  const response = await fetch(url, {
    ...options,
    headers: {
      ...options.headers,
      'Authorization': `Bearer ${token}`
    }
  });

  // Token过期，自动刷新
  if (response.status === 401) {
    await refreshAccessToken();
    // 重试请求
    return fetchWithAuth(url, options);
  }

  return response.json();
}

// 3. 刷新Token
async function refreshAccessToken() {
  const refreshToken = localStorage.getItem('refreshToken');
  const response = await fetch('/api/admin/auth/refresh', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ refreshToken })
  });
  const result = await response.json();

  if (result.code === 200) {
    localStorage.setItem('accessToken', result.data.accessToken);
  } else {
    // 刷新失败，跳转登录页
    localStorage.clear();
    window.location.href = '/login';
  }
}
```
